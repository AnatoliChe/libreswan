#!/bin/sh

# Wait until both whack can talk to pluto and the addconn process has
# disappeared.  This will delay until pluto is started

count=10
until test $count -eq 0 || \
	( ps=$(ipsec whack --processstatus 2>/dev/null) && echo "${ps}" | grep -v addconn > /dev/null )
do
    count=$(expr $count - 1)
    sleep 1
done

# what took so long?
if [ $count -eq 0 ]
then
   if echo $SUDO_COMMAND | grep "/bin/nsenter " > /dev/null 2>&1 ; then
	echo "pluto in namespace failed to start - check logs or output"
   else
	systemctl --full status ipsec.service
   fi
fi
